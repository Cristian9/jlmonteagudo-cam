<!DOCTYPE html>
<html lang="en">
	<head>
         <script src="/socket.io/socket.io.js"></script>
	</head>

	<body>
		<h1>STREAMING CAM</h1>
		<video id = "sourcevid" autoplay="true"></video>
		<canvas id = "output"></canvas>
		<div id = "log"></div>

		<script type="text/javascript">

			var log = function(msg) {
			       document.getElementById('log').innerHTML = document.getElementById('log').innerHTML + msg + "<br/>";
			    };
			    var video = document.getElementsByTagName('video')[0],
			        heading = document.getElementsByTagName('h1')[0];
			    if(navigator.getUserMedia) {
			        navigator.getUserMedia('video', successCallback, errorCallback);

			        function successCallback( stream ) {
			        	heading.textContent = "Emitiendo";
			            video.src = stream;
			        };

			        function errorCallback( error ) {
			            heading.textContent = "An error occurred: [CODE " + error.code + "]";
			        };
			    } else {
			        heading.textContent = "Native web camera streaming is not supported in this browser!";
			    };

			    var back = document.createElement('canvas');
			    var backcontext = back.getContext('2d');



			    /* SOCKET.IO */

			    var socket = io.connect('http://192.168.1.128:5000');


			    socket.on('connect', function () {
			    	log('connected');
			    });

			    socket.on('disconnect', function () {
			    	log('disconnected');
			    });

			    function send(msg) {
			    	socket.emit('data', msg);
			    }

			    /* END SOCKET.IO */




			    cw = 120;//240;//video.clientWidth;
			    ch = 200;//400;//video.clientHeight;
			    back.width = cw;
			    back.height = ch;
			    draw(video, backcontext, cw, ch);

			    function draw(v, bc, w, h) {
			        bc.drawImage(v, 0, 0, w, h);
			        var stringData=back.toDataURL();
			        send(stringData);
			        setTimeout(function(){ draw(v, bc, w, h); }, 100);
			    }

		</script>

	</body>

</html>
